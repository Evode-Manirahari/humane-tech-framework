<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ALMA - Reality-anchored conversations with built-in safeguards</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #faf9f7;
            color: #4a4a4a;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 20px;
        }

        .main-content {
            display: flex;
            flex-direction: column;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 2px 20px rgba(0,0,0,0.08);
            border: 1px solid #e8e6e3;
        }

        .header h1 {
            color: #8bc34a;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 1.1em;
        }

        .chat-container {
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 2px 20px rgba(0,0,0,0.08);
            border: 1px solid #e8e6e3;
            height: 500px;
            display: flex;
            flex-direction: column;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .message {
            margin-bottom: 15px;
            padding: 12px 16px;
            border-radius: 18px;
            max-width: 80%;
            word-wrap: break-word;
        }

        .user-message {
            background: #8bc34a;
            color: white;
            margin-left: auto;
            text-align: right;
        }

        .ai-message {
            background: #f5f5f5;
            color: #333;
        }

        .red-reply {
            background: #fff8e1 !important;
            border: 2px solid #ffb74d !important;
            position: relative;
        }

        .red-reply::before {
            content: "üïê MOMENT OF REFLECTION";
            position: absolute;
            top: -8px;
            left: 10px;
            background: #ffb74d;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .opposing-glance {
            background: #f3e5f5;
            border: 1px solid #ce93d8;
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
            font-style: italic;
            animation: fadeIn 0.5s ease-in;
        }

        .reflection-prompt {
            background: #e3f2fd;
            border: 1px solid #90caf9;
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
            font-weight: bold;
        }

        .human-support {
            background: #e8f5e8;
            border: 1px solid #8bc34a;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }

        .human-support h4 {
            color: #2e7d32;
            margin-bottom: 10px;
        }

        .human-support button {
            background: #8bc34a;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            margin: 5px;
            cursor: pointer;
        }

        .badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.8em;
            font-weight: bold;
            margin-right: 5px;
        }

        .badge.cited {
            background: #c8e6c9;
            color: #2e7d32;
        }

        .badge.inference {
            background: #fff3e0;
            color: #f57c00;
        }

        .badge.unverified {
            background: #ffcdd2;
            color: #c62828;
        }

        .bias-warning {
            background: #ffebee;
            border: 1px solid #f44336;
            border-radius: 6px;
            padding: 8px;
            margin: 5px 0;
            color: #c62828;
            font-size: 0.9em;
        }

        .tally {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            padding: 10px;
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
        }

        .tick {
            width: 8px;
            height: 8px;
            background: #8bc34a;
            border-radius: 50%;
        }

        .tick.overflow {
            background: #ff9800;
        }

        .input-container {
            display: flex;
            padding: 20px;
            border-top: 1px solid #e9ecef;
        }

        .input-container input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #ddd;
            border-radius: 25px;
            outline: none;
            font-size: 16px;
        }

        .input-container button {
            background: #8bc34a;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            margin-left: 10px;
            cursor: pointer;
            font-weight: bold;
        }

        .sidebar {
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 2px 20px rgba(0,0,0,0.08);
            border: 1px solid #e8e6e3;
            padding: 20px;
            height: fit-content;
            position: sticky;
            top: 20px;
        }

        .sidebar h3 {
            color: #8bc34a;
            margin-bottom: 15px;
        }

        .config-group {
            margin-bottom: 20px;
        }

        .config-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        .config-group select, .config-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
        }

        .feedback-panel {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            display: none;
        }

        .feedback-buttons {
            display: flex;
            gap: 10px;
            margin: 10px 0;
        }

        .feedback-buttons button {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
        }

        .feedback-buttons button.active {
            background: #8bc34a;
        }

        .feedback-buttons button.negative {
            background: #dc3545;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .status-indicator {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: bold;
            margin: 5px 0;
        }

        .status-connected {
            background: #d4edda;
            color: #155724;
        }

        .status-disconnected {
            background: #f8d7da;
            color: #721c24;
        }

        .status-quota {
            background: #fff3cd;
            color: #856404;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="main-content">
            <div class="header">
                <h1>ALMA</h1>
                <p>Reality-anchored conversations with built-in safeguards</p>
            </div>

            <div class="chat-container">
                <div class="chat-messages" id="chatMessages">
                    <div class="message ai-message">
                        <strong>ü§ñ ALMA:</strong> Welcome! I'm here to help with reality-anchored conversations. Try sending messages to see how ALMA's safeguards work.
                    </div>
                </div>
                <div class="tally" id="tally"></div>
                <div class="input-container">
                    <input type="text" id="messageInput" placeholder="Type your message..." onkeypress="handleKeyPress(event)">
                    <button onclick="sendMessage()">Send</button>
                </div>
            </div>
        </div>

        <div class="sidebar">
            <h3>‚öôÔ∏è Configuration</h3>
            
            <div class="config-group">
                <label>Red Reply Frequency:</label>
                <select id="redReplyFreq">
                    <option value="3">Every 3 prompts</option>
                    <option value="5" selected>Every 5 prompts</option>
                    <option value="7">Every 7 prompts</option>
                    <option value="10">Every 10 prompts</option>
                </select>
            </div>

            <div class="config-group">
                <label>Stance Threshold:</label>
                <select id="stanceThreshold">
                    <option value="1">Low (1.0)</option>
                    <option value="2" selected>Medium (2.0)</option>
                    <option value="3">High (3.0)</option>
                </select>
            </div>

            <div class="config-group">
                <label>Emotional Sensitivity:</label>
                <select id="emotionalSensitivity">
                    <option value="low">Low</option>
                    <option value="medium" selected>Medium</option>
                    <option value="high">High</option>
                </select>
            </div>

            <div class="config-group">
                <label>API Key (Optional):</label>
                <input type="password" id="apiKey" placeholder="sk-proj-...">
                <button onclick="testAPI()" style="width: 100%; margin-top: 5px;">Test Connection</button>
                <div id="apiStatus" class="status-indicator status-disconnected">Disconnected</div>
            </div>

            <div class="feedback-panel" id="feedbackPanel">
                <h4>üí≠ Feedback</h4>
                <p>How was this response?</p>
                <div class="feedback-buttons">
                    <button onclick="submitFeedback('positive')" class="feedback-btn">üëç Good</button>
                    <button onclick="submitFeedback('negative')" class="feedback-btn negative">üëé Poor</button>
                </div>
                <textarea placeholder="Optional comment..." id="feedbackComment" style="width: 100%; height: 60px; margin-top: 10px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
                <button onclick="hideFeedback()" style="width: 100%; margin-top: 5px;">Close</button>
            </div>
        </div>
    </div>

    <script>
        class ALMA {
            constructor() {
                this.config = {
                    redEveryNPrompts: 5,
                    stanceThreshold: 2.0,
                    emotionalSensitivity: 'medium',
                    stanceWindowMinutes: 25
                };
                this.promptCount = 0;
                this.stanceScore = 0;
                this.stanceHistory = [];
                this.sessionStart = Date.now();
                this.lastOpposingGlance = 0;
                this.emotionalLevel = 0;
                this.apiKey = '';
                this.apiStatus = 'disconnected';
            }

            countPrompt() {
                this.promptCount++;
                this.updateTally();
            }

            getInterventions(userMessage) {
                const interventions = {
                    shouldApplyRedReply: this.promptCount % this.config.redEveryNPrompts === 0,
                    shouldShowOpposingGlance: this.shouldShowOpposingGlance(userMessage),
                    shouldTriggerReflection: this.shouldTriggerReflection(),
                    shouldEscalateToHuman: this.detectEmotionalEscalation(userMessage),
                    shouldDetectBias: true
                };

                return interventions;
            }

            shouldShowOpposingGlance(message) {
                const now = Date.now();
                const timeSinceLastGlance = now - this.lastOpposingGlance;
                const sessionDuration = now - this.sessionStart;
                
                // Check if 25 minutes have passed (25 * 60 * 1000 = 1,500,000 ms)
                if (sessionDuration < 1500000) return false;
                
                // Don't show too frequently (at least 5 minutes apart)
                if (timeSinceLastGlance < 300000) return false;
                
                // Check for political/emotional content
                const politicalWords = ['politics', 'political', 'election', 'vote', 'democrat', 'republican', 'liberal', 'conservative', 'left', 'right'];
                const hasPoliticalContent = politicalWords.some(word => 
                    message.toLowerCase().includes(word)
                );
                
                if (!hasPoliticalContent) return false;
                
                // Check stance drift
                const averageStance = this.getAverageStance();
                if (Math.abs(averageStance) >= this.config.stanceThreshold) {
                    this.lastOpposingGlance = now;
                    return true;
                }
                
                return false;
            }

            shouldTriggerReflection() {
                // Trigger reflection every 10 prompts or when emotional level is high
                return this.promptCount % 10 === 0 || this.emotionalLevel > 0.7;
            }

            detectEmotionalEscalation(message) {
                const emotionalWords = ['anxious', 'depressed', 'sad', 'lonely', 'scared', 'worried', 'hopeless', 'suicidal', 'hurt', 'pain'];
                const crisisWords = ['kill myself', 'end it all', 'not worth living', 'better off dead'];
                
                const hasEmotionalContent = emotionalWords.some(word => 
                    message.toLowerCase().includes(word)
                );
                const hasCrisisContent = crisisWords.some(phrase => 
                    message.toLowerCase().includes(phrase)
                );
                
                if (hasCrisisContent) {
                    this.emotionalLevel = 1.0;
                    return true;
                }
                
                if (hasEmotionalContent) {
                    this.emotionalLevel = Math.min(1.0, this.emotionalLevel + 0.3);
                    return this.emotionalLevel > 0.8;
                }
                
                // Gradually decrease emotional level
                this.emotionalLevel = Math.max(0, this.emotionalLevel - 0.1);
                return false;
            }

            analyzeStance(message) {
                const leftWords = ['liberal', 'progressive', 'democrat', 'social justice', 'equality', 'climate change', 'universal healthcare'];
                const rightWords = ['conservative', 'republican', 'traditional', 'free market', 'small government', 'family values'];
                
                let score = 0;
                const words = message.toLowerCase().split(/\s+/);
                
                words.forEach(word => {
                    if (leftWords.some(lw => word.includes(lw))) score -= 1;
                    if (rightWords.some(rw => word.includes(rw))) score += 1;
                });
                
                // Add to stance history
                this.stanceHistory.push({
                    score: score,
                    timestamp: Date.now()
                });
                
                // Clean old history (keep last 25 minutes)
                this.cleanStanceHistory();
                
                this.stanceScore += score;
                return score;
            }

            getAverageStance() {
                if (this.stanceHistory.length === 0) return 0;
                const sum = this.stanceHistory.reduce((acc, entry) => acc + entry.score, 0);
                return sum / this.stanceHistory.length;
            }

            cleanStanceHistory() {
                const now = Date.now();
                this.stanceHistory = this.stanceHistory.filter(entry => 
                    now - entry.timestamp < this.config.stanceWindowMinutes * 60 * 1000
                );
            }

            generateOpposingGlance() {
                const currentStance = this.getAverageStance();
                const opposingStance = -Math.sign(currentStance) * 2;
                
                const opposingViews = {
                    '-2': [
                        "Consider this perspective: Some argue that market-driven solutions often create more efficient outcomes than government programs.",
                        "Alternative view: Traditional approaches have maintained stability in many societies for generations.",
                        "Different angle: Some studies suggest that individual responsibility leads to better long-term outcomes."
                    ],
                    '2': [
                        "Consider this perspective: Progressive policies have historically expanded rights and improved quality of life for many.",
                        "Alternative view: Social safety nets can prevent greater economic instability and human suffering.",
                        "Different angle: Collective action has often been necessary to address systemic inequalities."
                    ],
                    '0': [
                        "Consider this perspective: The issue might be more complex than any single viewpoint captures.",
                        "Alternative view: There may be valid concerns on multiple sides of this discussion.",
                        "Different angle: Perhaps the solution lies in finding common ground rather than choosing sides."
                    ]
                };
                
                const views = opposingViews[opposingStance.toString()] || opposingViews['0'];
                return views[Math.floor(Math.random() * views.length)];
            }

            generateReflectionPrompt() {
                const prompts = [
                    "What do we know vs what did we assume so far?",
                    "What evidence supports our current position?",
                    "What might we be missing from other perspectives?",
                    "How confident are we in our conclusions?",
                    "What would change our mind on this topic?",
                    "Are we building on facts or assumptions?",
                    "What questions should we ask next?",
                    "How might someone with different views see this?"
                ];
                
                return prompts[Math.floor(Math.random() * prompts.length)];
            }

            generateRealityAnchors(text) {
                const citedPattern = /according to|research shows|studies indicate|data suggests|statistics show|experts say/i;
                const inferencePattern = /might be|could be|probably|likely|suggests|appears to|seems to/i;
                
                if (citedPattern.test(text)) {
                    return text.replace(citedPattern, 
                        '<span class="badge cited">[Cited]</span> $&');
                } else if (inferencePattern.test(text)) {
                    return text.replace(inferencePattern, 
                        '<span class="badge inference">[Inference]</span> $&');
                } else {
                    return `<span class="badge unverified">[Unverified]</span> ${text}`;
                }
            }

            detectBias(text) {
                const biases = [];
                
                // Gender bias
                if (/he should|she should|men are|women are|guys|girls/i.test(text)) {
                    biases.push("Potential gender bias detected");
                }
                
                // Racial bias
                if (/they are|those people|typical|always|never/i.test(text)) {
                    biases.push("Potential racial/cultural bias detected");
                }
                
                // Age bias
                if (/young people|old people|millennials|boomers|kids these days/i.test(text)) {
                    biases.push("Potential age bias detected");
                }
                
                // Ability bias
                if (/normal people|disabled|handicapped|special needs/i.test(text)) {
                    biases.push("Potential ability bias detected");
                }
                
                // Socioeconomic bias
                if (/poor people|rich people|lazy|entitled|privileged/i.test(text)) {
                    biases.push("Potential socioeconomic bias detected");
                }
                
                return biases;
            }

            async callOpenAI(message) {
                if (!this.apiKey || this.apiStatus !== 'connected') {
                    return this.generateSimulatedResponse(message);
                }

                try {
                    const response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${this.apiKey}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            model: 'gpt-4o-mini',
                            messages: [
                                {
                                    role: 'system',
                                    content: 'You are ALMA, a helpful AI assistant focused on reality-anchored conversations. Always be honest about what you know vs what you infer. Use [Cited], [Inference], or [Unverified] labels when appropriate.'
                                },
                                {
                                    role: 'user',
                                    content: message
                                }
                            ],
                            max_tokens: 500,
                            temperature: 0.7
                        })
                    });

                    if (!response.ok) {
                        if (response.status === 429) {
                            this.apiStatus = 'quota';
                            return this.generateSimulatedResponse(message);
                        }
                        throw new Error('API request failed');
                    }

                    const data = await response.json();
                    return data.choices[0].message.content;
                } catch (error) {
                    console.error('OpenAI API error:', error);
                    this.apiStatus = 'disconnected';
                    return this.generateSimulatedResponse(message);
                }
            }

            generateSimulatedResponse(message) {
                const responses = [
                    "I understand your question. Let me think through this step by step.",
                    "That's an interesting perspective. Here's what I can share about this topic.",
                    "I appreciate you bringing this up. Let me provide some thoughts on this.",
                    "This is a complex topic that deserves careful consideration.",
                    "I can help you explore this further. Here's what comes to mind.",
                    "That's a thoughtful question. Let me break this down for you.",
                    "I see what you're getting at. Here's my perspective on this.",
                    "This is worth discussing. Let me share some insights."
                ];
                
                return responses[Math.floor(Math.random() * responses.length)] + " " + 
                       "This is a simulated response. For real AI assistance, please add your OpenAI API key.";
            }

            updateTally() {
                const tally = document.getElementById('tally');
                tally.innerHTML = '';
                
                for (let i = 0; i < this.promptCount; i++) {
                    const tick = document.createElement('div');
                    tick.className = 'tick';
                    if (i >= 20) {
                        tick.className += ' overflow';
                    }
                    tally.appendChild(tick);
                }
                
                if (this.promptCount > 20) {
                    const overflow = document.createElement('div');
                    overflow.textContent = `+${this.promptCount - 20} more`;
                    overflow.className = 'tick overflow';
                    tally.appendChild(overflow);
                }
            }

            getSessionDuration() {
                const now = Date.now();
                const duration = now - this.sessionStart;
                const minutes = Math.floor(duration / 60000);
                const seconds = Math.floor((duration % 60000) / 1000);
                return `${minutes}m ${seconds}s`;
            }
        }

        const alma = new ALMA();

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message
            addMessage(message, true);
            input.value = '';
            
            // Count prompt
            alma.countPrompt();
            
            // Analyze stance
            alma.analyzeStance(message);
            
            // Get interventions
            const interventions = alma.getInterventions(message);
            
            // Generate AI response
            generateAIResponse(message, interventions);
        }

        async function generateAIResponse(userMessage, interventions) {
            // Show typing indicator
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message ai-message';
            typingDiv.innerHTML = '<em>ALMA is thinking...</em>';
            document.getElementById('chatMessages').appendChild(typingDiv);
            
            // Get AI response
            const aiResponse = await alma.callOpenAI(userMessage);
            
            // Remove typing indicator
            typingDiv.remove();
            
            // Apply reality anchors
            const anchoredResponse = alma.generateRealityAnchors(aiResponse);
            
            // Check for bias
            const biases = alma.detectBias(aiResponse);
            
            // Determine UI flags
            const isRedReply = interventions.shouldApplyRedReply;
            const hasOpposingGlance = interventions.shouldShowOpposingGlance;
            const hasReflectionPrompt = interventions.shouldTriggerReflection;
            const hasHumanOptions = interventions.shouldEscalateToHuman;
            
            // Add AI message with all interventions
            addMessage(anchoredResponse, false, isRedReply, hasOpposingGlance, hasHumanOptions, hasReflectionPrompt, biases);
        }

        function addMessage(content, isUser = false, isRedReply = false, hasOpposingGlance = false, hasHumanOptions = false, hasReflectionPrompt = false, biases = []) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user-message' : 'ai-message'} ${isRedReply ? 'red-reply' : ''}`;
            
            let messageContent = content;
            
            // Add opposing glance if needed
            if (hasOpposingGlance && !isUser) {
                const opposingView = alma.generateOpposingGlance();
                messageContent += `
                    <div class="opposing-glance">
                        <strong>üîÑ Opposing Glance:</strong> ${opposingView}
                    </div>
                `;
            }
            
            // Add reflection prompt if needed
            if (hasReflectionPrompt && !isUser) {
                const reflection = alma.generateReflectionPrompt();
                messageContent += `
                    <div class="reflection-prompt">
                        <strong>ü§î Reflection:</strong> ${reflection}
                    </div>
                `;
            }
            
            // Add human support options if needed
            if (hasHumanOptions && !isUser) {
                messageContent += `
                    <div class="human-support">
                        <h4>üíö Human Support Available</h4>
                        <p>Consider reaching out to someone you trust:</p>
                        <button onclick="openEmailApp()">üìß Email a Friend</button>
                        <button onclick="openMessagesApp()">üí¨ Text Someone</button>
                        <button onclick="openTherapistFinder()">ü©∫ Find Therapist</button>
                    </div>
                `;
            }
            
            // Add bias warnings if detected
            if (biases.length > 0 && !isUser) {
                biases.forEach(bias => {
                    messageContent += `<div class="bias-warning">‚ö†Ô∏è ${bias}</div>`;
                });
            }
            
            messageDiv.innerHTML = messageContent;
            document.getElementById('chatMessages').appendChild(messageDiv);
            document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
            
            // Show feedback panel for AI messages
            if (!isUser) {
                setTimeout(() => {
                    document.getElementById('feedbackPanel').style.display = 'block';
                }, 1000);
            }
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        function testAPI() {
            const apiKey = document.getElementById('apiKey').value.trim();
            if (!apiKey) {
                alert('Please enter an API key');
                return;
            }
            
            alma.apiKey = apiKey;
            alma.apiStatus = 'testing';
            
            const statusDiv = document.getElementById('apiStatus');
            statusDiv.textContent = 'Testing...';
            statusDiv.className = 'status-indicator status-disconnected';
            
            // Test the API
            fetch('https://api.openai.com/v1/models', {
                headers: {
                    'Authorization': `Bearer ${apiKey}`
                }
            })
            .then(response => {
                if (response.ok) {
                    alma.apiStatus = 'connected';
                    statusDiv.textContent = 'Connected';
                    statusDiv.className = 'status-indicator status-connected';
                } else if (response.status === 429) {
                    alma.apiStatus = 'quota';
                    statusDiv.textContent = 'Quota Exceeded';
                    statusDiv.className = 'status-indicator status-quota';
                } else {
                    throw new Error('API test failed');
                }
            })
            .catch(error => {
                alma.apiStatus = 'disconnected';
                statusDiv.textContent = 'Connection Failed';
                statusDiv.className = 'status-indicator status-disconnected';
            });
        }

        function submitFeedback(type) {
            const comment = document.getElementById('feedbackComment').value;
            console.log(`Feedback: ${type}`, comment);
            
            // Update button states
            document.querySelectorAll('.feedback-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Hide panel after a delay
            setTimeout(() => {
                hideFeedback();
            }, 2000);
        }

        function hideFeedback() {
            document.getElementById('feedbackPanel').style.display = 'none';
            document.getElementById('feedbackComment').value = '';
        }

        function openEmailApp() {
            window.open('mailto:', '_blank');
        }

        function openMessagesApp() {
            alert('This would open your default messaging app');
        }

        function openTherapistFinder() {
            window.open('https://www.psychologytoday.com/us/therapists', '_blank');
        }

        // Configuration updates
        document.getElementById('redReplyFreq').addEventListener('change', (e) => {
            alma.config.redEveryNPrompts = parseInt(e.target.value);
        });

        document.getElementById('stanceThreshold').addEventListener('change', (e) => {
            alma.config.stanceThreshold = parseFloat(e.target.value);
        });

        document.getElementById('emotionalSensitivity').addEventListener('change', (e) => {
            alma.config.emotionalSensitivity = e.target.value;
        });

        // Auto-test API on load if key is present
        window.addEventListener('load', () => {
            const apiKey = document.getElementById('apiKey').value;
            if (apiKey) {
                testAPI();
            }
        });
    </script>
</body>
</html>
